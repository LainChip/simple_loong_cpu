# simd 指令集

## 指令集目标

simd 指令集为一个小型的高效 dsp 设计，计划用于加速计算密集的任务。
该指令集早期的设计任务，是作为一个"顶点着色器"，参与计算三维顶点变换。
为此，指令集需要可以快速的完成 TCM 上的 4x4 - 4x4 矩阵乘法运算，以及对主线内存上的向量进行 4x4 - 4 变换运算并写回。

## 指令集实现设计

指令集为 RISC 指令集，有 32 个通用标量寄存器(0号只读) 与 32 个通用向量寄存器(0号只读)。

为了简化解码，指令仅两种格式，分别为 IW, 和ISRRW
IW 被用于立即数加载，函数调用式跳转。
I 18位，W 为 5位。

ISRRW 被用于其他的所有指令。
I 为一个 5 位立即数，可用由指令选择其功能， S 为一个三位的 simd flag，标识三个寄存器的类型。

RRW 为三个寄存器号，分别为 r[0] r[1] w，可为向量寄存器或标量寄存器。

高 9 位为指令选择信息。
最高 3 位用于区别指令分区，目前分为 6 区：

```
    SPC,      // 特殊控制指令，及分支。 指令格式部分为 IW，I 为 18 位，其余为 ISRRW
    INTEGR,   // 简单整数单元 指令格式为 ISRRW，I 为 5 位，S 为 3位 simd flag，标记读写寄存器类型。
    MULDIV,   // 整乘除法单元
    DBUS,     // 数据总线
    FPU,      // 浮点单元
    TCM       // 紧连接存储空间 (32k = 4k字 = 12位完成寻址)
```

之后 6 位为 opcode，交由每个模块决定其功能。



寻址上，使用寄存器进行寻址，r[1] + I 为目标地址。



这种设计的指令编码，基本上不需要解码级，大幅度简化设计逻辑的复杂度。



实现为了简化，同时提供可用的性能，使用最短4级流水，顺序发射，乱序提交（计分板方法，无寄存器重命名）。

IF | D-REG-BPU-IS | EX-MEM | WREG

所有的指令会在 EX 级，由不同的单元执行，在每个单元中的执行时间是不确定的，对于发射的指令，也可以由每个执行单元对其执行顺序进行调度，即发射后的指令不需要撤销，未提交的指令中不存在任何类型数据相关， R-W，W-R，W-W，使用计分板策略在发射时标记所有未提交的寄存器，并检查是否满足所有需求寄存器已提交作为条件。

模块与外部 使用两组 valid-ready 信号进行握手，模块不需要保证每次处理之间的间隔，所有模块要求实现一个额外的 payload 端口，用于承载指令的提交相关信息。在提交阶段，对于标量和向量寄存器，分别使用一个 round-robin 算法进行公平调度的策略，处理写冲突。